<!doctype html>
<html>
<head>
	<style type='text/css'>
		body {
			margin: 0px;
			padding: 0px;
			font: 1.6em 'Georgia', 'Tahoma', serif;
			color: #333;
		}

		#content {
			width: 940px;
			margin: 0 auto;
		}

		input, textarea, button {
			font: 15px 'Monaco', 'Bitstream Vera Sans', 'Courier', monospace;
		}
		body {
			overflow: hidden;
		}

		#input-field {
			position: absolute;
			left: 10px;
			right:10px;
			bottom:20px;
			top:175px;
		}
	</style>
</head>
<body>
	<div id="content">
		<h1>Pastie</h1>
		<span style='float:right'>
			<label for='language'>Language:</label>
			<select id='language'>
				<option value='text'>Plaintext</option>
				<option value='javascript'>Javascript</option>
				<option value='json'>JSON</option>
				<option value='csharp'>C#</option>
				<option value='perl'>Perl</option>
			</select>
		</span>
		<div id="input-field"></div>
		<button id="save-button">Save</button>
		<span style='float:right'>
			<label for='short_url'>Short URL:</label>
			<input type='text' disabled='disabled' id='short_url'></input>
		</span>
	</div>



	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/ace-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/mode-xml-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/mode-javascript-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/mode-perl-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/mode-csharp-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/mode-json-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/mode-text-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/base64.js" type="text/javascript"></script>
	<script src="/static/js/rawdeflate.js" type="text/javascript"></script>
	<script src="/static/js/rawinflate.js" type="text/javascript"></script>
	<script type="text/javascript">

		function initEditor() {
			window.aceEditor = ace.edit("input-field");
			window.aceEditor.setTheme("ace/theme/monokai");
			window.aceEditor.renderer.setShowPrintMargin(false);
			window.aceEditor.setHighlightActiveLine(false);
		};

		function setAceMode( language ){
			var XMLMode = ace.require("ace/mode/xml").Mode
				, JSMode = ace.require("ace/mode/javascript").Mode
				, PerlMode = ace.require("ace/mode/perl").Mode
				, CsharpMode = ace.require("ace/mode/csharp").Mode
				, JSONMode = ace.require("ace/mode/json").Mode
				, TextMode = ace.require("ace/mode/text").Mode

			if ( language === 'text'){
				window.aceEditor.getSession().setMode(new TextMode());
			}else if( language === 'javascript'){
				window.aceEditor.getSession().setMode(new JSMode());
			}else if( language === 'json'){
				window.aceEditor.getSession().setMode(new JSONMode());
			}else if( language === 'csharp'){
				window.aceEditor.getSession().setMode(new CsharpMode());
			}else if( language === 'perl'){
				window.aceEditor.getSession().setMode(new PerlMode());
			}
		}

		$(function(){

			initEditor();

			var base64
			, check
			, checksum
			, deflated
			, encoded
			, input
			, get_short_url;

			get_short_url = function(url){
				$.getJSON(
					"http://api.bitly.com/v3/shorten?callback=?"
					, {
						"format": "json"
						, "apiKey": "R_db4dda4e46e10ee6f38868ecf63359c5"
						, "login": "tjkells"
						, "longUrl": url
					},
					function(res){
						$('#short_url').val(res.data.url)
					}
				);
			}
			checksum = function(string) {
				var chk, chr, i;
				chk = 0;
				for (i in string) {
					chr = string[i];
					chk += chr.charCodeAt(0) * (i + 1);
				}
				return chk % 10;
			};

			$('#language').change(function(){
				setAceMode(this.value)
			})

			$('#save-button').click(function(){
				var base64
					, check
					, deflated
					, encoded
					, input
					, data;

				input = window.aceEditor.getSession().getValue()
				language = $('#language').val();

				//Add on some meta-data wooooo
				data = {
					"paste_data": input
					,"language": language
				}
				deflated = RawDeflate.deflate(JSON.stringify(data));
				base64 = Base64.toBase64(deflated);
				//generate a checksum and tack it onto the end of the base64 encoded string
				//check = checksum(base64);
				encoded = base64 //+ check;
				window.location.hash = encoded;
				get_short_url(window.location.href);

			});

			if (window.location.hash) {
				get_short_url(window.location.href);
				encoded = window.location.hash.replace(/^#/, '');
				window.location.hash = '';
				base64 = encoded.slice(0, (encoded.length - 2) + 1 || 9e9);
				//check = parseInt(encoded.slice(encoded.length - 1, encoded.length + 1 || 9e9));
				//if (check !== checksum(base64)) {
				//	return alert('Something got corrupted :(');
				//} else {
				deflated = Base64.fromBase64(base64);
				input = RawDeflate.inflate(deflated);
				var decoded_input = JSON.parse(input)
				$('#language').val(decoded_input.language)
				window.aceEditor.getSession().setValue(decoded_input.paste_data)
				setAceMode(decoded_input.language)
				return true
				//}
			}
		})
	</script>

</body>
</html>
